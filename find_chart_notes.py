from modules.healthie import Healthie

PAGE_SIZE = 20  # The number of users to request per page (determine the server's limit)
# 20 appears to be the max here

PROD_PROVIDERS = {
    "10410358": "Karam Elabd",
    "10578403": "Tim Herby",
    "10666933": "Bridget Krueger",
    "10578423": "Rakesh Patel",
    "11008105": "Janelle Scachetti",
    "11008180": "Andrea Stage",
    "10578357": "Johann Windt",
    # 10410358 Karam Elabd          karam@cascaidhealth.com
    # 10578403 Tim Herby            tim@cascaidhealth.com
    # 10666933 Bridget Krueger      bridget@cascaidhealth.com
    # 10578423 Rakesh Patel         rakesh@cascaidhealth.com
    # 11008105 Janelle Scachetti    janelle@cascaidhealth.com
    # 11008180 Andrea Stage         andrea@cascaidhealth.com
    # 10578357 Johann Windt         johann@cascaidhealth.com
}

# FIELDS = ['PROVIDER_ID', 'PROVIDER_NAME', 'RANK', 'ARTICLE', 'COUNTRY']
# FILENAME = 'patient_chat_responses.csv'


def main():
    H = Healthie("PROD")

    # with open(FILENAME, 'w', newline='') as csvfile:
    #     writer = DictWriter(csvfile, fieldnames=FIELDS)

    #     writer.writeheader()

    chat_count = 0
    response_count = 0
    provider_counts = {}
    auto_chats = 0
    viewed_counts = 0

    for provider_id in PROD_PROVIDERS:
        chats = 0
        responses = 0
        views = 0
        offset = 0
        all_charts = []

        print(f"Provider: {provider_id} {PROD_PROVIDERS[provider_id]}")
        print("---------------------------------")

        # Loop until a page returns fewer results than the limit (PAGE_SIZE)
        more_to_get = True

        while more_to_get:
            # Define the variables for the current query
            variables = {
                # "org_chat": True,
                "provider_ids ": [str(provider_id)],
                "offset": offset,
                "page_size": PAGE_SIZE,
            }

            response = H.list_charts(variables)

            chart_notes = response["chartNotes"]

            all_charts.extend(chart_notes)
            print(
                f"Fetched {len(chart_notes)} chart notes at offset {offset}. Total so far: {len(all_charts)}"
            )

            if not chart_notes:
                print("No chart notes to fetch. Loop complete.")
                more_to_get = False

            offset += PAGE_SIZE

        # processed_charts = []

        for chart in all_charts:
            print(
                f"Chart: {chart['id']} - {chart['chart_note_status']} - finished: {chart['finished']} - created: {chart['created_at']} - {chart['name']} - filler: [{chart['filler']['id']} - {chart['filler']['name']}] - user: {chart['user']['id']}"
            )
        #     patient_id = conversation['convo']['patient_id']
        #     last_note_viewed_id = conversation['convo']['last_note_viewed_id']
        #     if last_note_viewed_id:
        #         views += 1
        #     print(f"Conversation: {conversation['conversation_id']} - Display Name: {conversation['display_name']} - Patient ID: {patient_id} - Last Note viewed by Patient: {last_note_viewed_id}")

        #     variables = {
        #         "conversation_id": conversation['conversation_id']
        #     }

        #     response = H.get_notes(variables)

        #     if len(response['notes']) == 0:
        #         print("  No notes found")
        #         continue

        #     first_note = response['notes'][-1]

        #     started_by_navigator = first_note['creator']['id'] == provider_id

        #     if started_by_navigator:
        #         chats += 1

        #         is_autogenerated = "your Care Navigator" in first_note['content']
        #         if is_autogenerated:
        #             auto_chats += 1

        #         if len(response['notes']) == 1:
        #             print("  Started by navigator, but no response")
        #         else:
        #             client_responded = False
        #             idx = 0
        #             for note in response['notes']:
        #                 idx += 1
        #                 responded_by_patient = note['creator']['id'] == patient_id
        #                 if (not client_responded) and responded_by_patient:
        #                     client_responded = True
        #                     responses += 1
        #                     print(f"  Started by navigator, first client response on note {idx}")

        # for note in response['notes']:
        #     print(f"    Note: {note['id']} - {note['created_at']} - {note['creator']['id']} - {note['is_autoresponse']}")

        provider_counts[provider_id] = {
            "chats": chats,
            "responses": responses,
            "views": views,
        }

        chat_count += chats
        response_count += responses
        viewed_counts += views

        print("================================")

    print(
        f"Total chats: {chat_count}, Total viewed: {viewed_counts}, Total responses: {response_count}, auto-started: {auto_chats}"
    )

    for provider_id in provider_counts:
        print(
            f"Provider: {provider_id} {PROD_PROVIDERS[provider_id]:18} - Chats: {provider_counts[provider_id]['chats']:2} - Views: {provider_counts[provider_id]['views']:2} - Responses: {provider_counts[provider_id]['responses']:2}"
        )

        # {
        #     "data": {
        #         "conversationMemberships": [
        #         {
        #             "conversation_id": "4304139",
        #             "display_name": "To Mato"
        #         },


if __name__ == "__main__":
    main()
