from modules.healthie import Healthie

PAGE_SIZE = 20  # The number of users to request per page (determine the server's limit)
# 20 appears to be the max here

PROD_PROVIDERS = {
    "10410358": "Karam Elabd",
    "10578403": "Tim Herby",
    "10666933": "Bridget Krueger",
    "10578423": "Rakesh Patel",
    "11008105": "Janelle Scachetti",
    "11008180": "Andrea Stage",
    "10578357": "Johann Windt",
    # 10410358 Karam Elabd          karam@cascaidhealth.com
    # 10578403 Tim Herby            tim@cascaidhealth.com
    # 10666933 Bridget Krueger      bridget@cascaidhealth.com
    # 10578423 Rakesh Patel         rakesh@cascaidhealth.com
    # 11008105 Janelle Scachetti    janelle@cascaidhealth.com
    # 11008180 Andrea Stage         andrea@cascaidhealth.com
    # 10578357 Johann Windt         johann@cascaidhealth.com
}

# FIELDS = ['PROVIDER_ID', 'PROVIDER_NAME', 'RANK', 'ARTICLE', 'COUNTRY']
# FILENAME = 'patient_chat_responses.csv'


def main():
    H = Healthie("PROD")

    offset = 0
    all_faxes = []

    # Loop until a page returns fewer results than the limit (PAGE_SIZE)
    more_to_get = True

    while more_to_get:
        # Define the variables for the current query
        variables = {"offset": offset, "page_size": PAGE_SIZE}

        response = H.list_faxes(variables)

        sent_faxes = response["sentFaxes"]

        all_faxes.extend(sent_faxes)
        print(
            f"Fetched {len(sent_faxes)} sent faxes at offset {offset}. Total so far: {len(all_faxes)}"
        )

        if not sent_faxes:
            print("No sent faxes to fetch. Loop complete.")
            more_to_get = False

        offset += PAGE_SIZE

    # processed_faxes = []

    for fax in all_faxes:
        print(
            f"{fax['id']} - {fax['destination_number']} - To: [{fax['patient']['id']} - {fax['patient']['name']}] - From: [{fax['sender']['id']} - {fax['sender']['name']}] - Status: {fax['status_display_string']}"
        )

        #     patient_id = conversation['convo']['patient_id']
        #     last_note_viewed_id = conversation['convo']['last_note_viewed_id']
        #     if last_note_viewed_id:
        #         views += 1
        #     print(f"Conversation: {conversation['conversation_id']} - Display Name: {conversation['display_name']} - Patient ID: {patient_id} - Last Note viewed by Patient: {last_note_viewed_id}")

        #     variables = {
        #         "conversation_id": conversation['conversation_id']
        #     }

        #     response = H.get_notes(variables)

        #     if len(response['notes']) == 0:
        #         print("  No notes found")
        #         continue

        #     first_note = response['notes'][-1]

        #     started_by_navigator = first_note['creator']['id'] == provider_id

        #     if started_by_navigator:
        #         chats += 1

        #         is_autogenerated = "your Care Navigator" in first_note['content']
        #         if is_autogenerated:
        #             auto_chats += 1

        #         if len(response['notes']) == 1:
        #             print("  Started by navigator, but no response")
        #         else:
        #             client_responded = False
        #             idx = 0
        #             for note in response['notes']:
        #                 idx += 1
        #                 responded_by_patient = note['creator']['id'] == patient_id
        #                 if (not client_responded) and responded_by_patient:
        #                     client_responded = True
        #                     responses += 1
        #                     print(f"  Started by navigator, first client response on note {idx}")

        # for note in response['notes']:
        #     print(f"    Note: {note['id']} - {note['created_at']} - {note['creator']['id']} - {note['is_autoresponse']}")


if __name__ == "__main__":
    main()
